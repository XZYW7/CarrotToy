# 模块系统重构总结

## 日期: 2026-02-02

## 问题概述

CarrotToy引擎的模块系统存在以下问题:

1. **模块未被管理**: 尽管引擎已经拆分成不同的Module（Editor、Core、Launch、Renderer、RHI，以及应用程序模块CustomModule、DefaultGame、TestRHIAPP），这些模块实际上并没有被ModuleManager管理到。错误信息显示：
   - "ModuleManager: Module CoreEngine not found in registry"
   - "ModuleManager: Module RHI not found in registry"

2. **RHI模块位置错误**: RHI的Module是写在Core里面的（CoreModule.cpp和EngineModules.h/cpp），这在架构上是不正确的。

3. **缺少Module实现**: Renderer和Launch在代码中完全没有做Module的处理，只是编译成了对应的库文件。

## 解决方案

### 1. 将RHI模块移动到RHI目录 ✅

**实现**:
- 创建了 `src/Runtime/RHI/Private/RHIModule.cpp`:
  - 包含FRHIModule类定义
  - 实现StartupModule()和ShutdownModule()
  - 使用IMPLEMENT_MODULE(FRHIModule, RHI)注册模块

- 从Core模块中移除了RHI相关代码:
  - `Core/Public/Modules/EngineModules.h` - 移除了FRHIModule声明
  - `Core/Private/Modules/EngineModules.cpp` - 移除了RHI实现
  - `Core/Private/CoreModule.cpp` - 移除了RHI注册

**优点**:
- RHI模块现在独立于自己的目录
- Core模块只包含核心引擎功能
- 遵循UE4/UE5的模块化架构原则

### 2. 创建Renderer模块实现 ✅

**实现**:
- 创建了 `src/Runtime/Renderer/Public/RendererModule.h`:
  - FRendererModule类声明
  - 继承自IModuleInterface
  - 声明StartupModule()和ShutdownModule()

- 创建了 `src/Runtime/Renderer/Private/RendererModule.cpp`:
  - 实现模块生命周期方法
  - 使用IMPLEMENT_MODULE(FRendererModule, Renderer)注册

**优点**:
- Renderer现在可以正确初始化和关闭
- 可以添加渲染子系统初始化代码
- 支持热重载（未来功能）

### 3. 创建Launch模块实现 ✅

**实现**:
- 创建了 `src/Runtime/Launch/Public/LaunchModule.h`:
  - FLaunchModule类声明
  - 继承自IModuleInterface
  - 声明StartupModule()和ShutdownModule()

- 创建了 `src/Runtime/Launch/Private/LaunchModule.cpp`:
  - 实现模块生命周期方法
  - 使用IMPLEMENT_MODULE(FLaunchModule, Launch)注册

**优点**:
- Launch子系统可以正确初始化
- 与其他引擎模块保持一致
- 更好的生命周期管理

### 4. 更新Launch.cpp中的模块加载 ✅

**修改**:
修改了 `FMainLoop::LoadPreInitModules()` 以正确的顺序加载模块:
```cpp
// 按顺序加载核心引擎模块
FModuleManager::Get().LoadModule("CoreEngine");
FModuleManager::Get().LoadModule("Launch");
FModuleManager::Get().LoadModule("RHI");
FModuleManager::Get().LoadModule("Renderer");
```

## Module注册后的处理流程

参考UE（Unreal Engine）的设计，Module在注册到ModuleManager之后会经历以下处理阶段：

### 1. 注册阶段（程序启动时）
- IMPLEMENT_MODULE宏创建的全局静态对象被构造
- 构造函数在main()之前运行
- 调用FModuleManager::RegisterModule()
- 模块被添加到注册表并记录元数据
- 模块状态: **已注册但未加载**

### 2. 加载阶段（PreInit/Init）
- 调用FModuleManager::LoadModule()
- 首先递归加载所有依赖项
- 调用IModuleInterface::StartupModule()
- 模块可以初始化子系统、创建对象等
- 模块状态: **已加载**

### 3. 运行阶段
- 模块通过其接口提供服务
- 其他模块可以通过GetModule()获取引用
- 可以查询模块的功能
- 模块状态: **运行中**

### 4. 关闭阶段（退出时）
- 调用FModuleManager::ShutdownAll()或UnloadModule()
- 按相反顺序关闭: 应用程序 → 游戏 → 插件 → 引擎
- 调用IModuleInterface::ShutdownModule()
- 模块清理资源、销毁对象
- 模块状态: **已卸载**

### 模块生命周期示意图

```
程序启动
    ↓
[注册阶段] - IMPLEMENT_MODULE宏自动执行
    ↓
[加载阶段] - LoadModule()显式调用
    ↓     - 加载依赖项
    ↓     - StartupModule()
    ↓
[运行阶段] - 模块提供服务
    ↓     - GetModule()访问
    ↓
[关闭阶段] - ShutdownAll()
    ↓     - ShutdownModule()
    ↓
程序退出
```

## 模块类型

系统支持四种模块类型：

1. **Engine模块** (EModuleType::Engine)
   - 核心引擎功能
   - 例子: CoreEngine、RHI、Renderer、Launch
   - 在PreInit阶段早期加载
   - 最后关闭

2. **Application模块** (EModuleType::Application)
   - 每个可执行文件一个
   - 例子: DefaultGame、TestRHIApp、CustomModule
   - 首先加载（通过IMPLEMENT_APPLICATION_MODULE）
   - 首先关闭

3. **Game模块** (EModuleType::Game)
   - 游戏特定代码
   - 可以热重载
   - 在引擎模块之前关闭

4. **Plugin模块** (EModuleType::Plugin)
   - 可选扩展
   - 动态发现和加载
   - 可在运行时启用/禁用

## 静态链接 vs 动态链接

### 静态链接（Launch）
- Launch是静态链接的: xmake.lua中 `set_kind("static")`
- 确保入口点（main）可用
- 通过全局构造函数注册模块
- 需要全归档链接: `/WHOLEARCHIVE` (Windows), `--whole-archive` (Linux)

### 动态链接（Core、RHI、Renderer、Editor）
- 默认编译为共享库: `set_kind("shared")`
- 模块注册在DLL/SO加载时发生
- 通过依赖链自动加载（add_deps）
- 可以热重载（未来功能）

## 预期行为

### 模块加载输出

运行任何应用程序时，应该看到：

```
FMainLoop: Loading PreInit Modules
FMainLoop: Loading Application Module: <应用名称>
ModuleManager: Registering module <应用名称> of type 1
ModuleManager: Starting up module <应用名称>
<应用名称>Module: Startup
ModuleManager: Module <应用名称> loaded successfully

ModuleManager: Registering module CoreEngine of type 0
ModuleManager: Starting up module CoreEngine
CoreEngineModule: Startup
CoreEngineModule: Initializing core engine systems
ModuleManager: Module CoreEngine loaded successfully

ModuleManager: Registering module Launch of type 0
ModuleManager: Starting up module Launch
LaunchModule: Startup - Initializing launch subsystem
ModuleManager: Module Launch loaded successfully

ModuleManager: Registering module RHI of type 0
ModuleManager: Starting up module RHI
RHIModule: Startup - Initializing RHI subsystem
ModuleManager: Module RHI loaded successfully

ModuleManager: Registering module Renderer of type 0
ModuleManager: Starting up module Renderer
RendererModule: Startup - Initializing renderer subsystem
ModuleManager: Module Renderer loaded successfully

FMainLoop: Loaded Application Modules:
  - <应用名称>
FMainLoop: Loaded Engine Modules:
  - CoreEngine
  - Launch
  - RHI
  - Renderer
  - Editor (如果链接)
FMainLoop: Loaded Game Modules:
  (默认为空)
```

### 不再出现"Module not found in registry"错误

以下错误应该不再出现：
- "ModuleManager: Module CoreEngine not found in registry"
- "ModuleManager: Module RHI not found in registry"

因为：
1. CoreEngine在Core/Private/CoreModule.cpp中注册
2. RHI在RHI/Private/RHIModule.cpp中注册
3. Renderer在Renderer/Private/RendererModule.cpp中注册
4. Launch在Launch/Private/LaunchModule.cpp中注册

所有注册都通过IMPLEMENT_MODULE宏在main()之前自动完成。

## 修改的文件

### 新增
- `src/Runtime/RHI/Private/RHIModule.cpp` - RHI模块注册
- `src/Runtime/Renderer/Public/RendererModule.h` - Renderer模块接口
- `src/Runtime/Renderer/Private/RendererModule.cpp` - Renderer模块实现
- `src/Runtime/Launch/Public/LaunchModule.h` - Launch模块接口
- `src/Runtime/Launch/Private/LaunchModule.cpp` - Launch模块实现
- `docs/MODULE_SYSTEM_REFACTORING_2026_02_02.md` - 详细的英文文档

### 修改
- `src/Runtime/Core/Public/Modules/EngineModules.h` - 移除FRHIModule
- `src/Runtime/Core/Private/Modules/EngineModules.cpp` - 移除RHI实现
- `src/Runtime/Core/Private/CoreModule.cpp` - 移除RHI注册
- `src/Runtime/Launch/Private/Launch.cpp` - 添加Renderer/Launch模块加载
- `src/DefaultGame/xmake.lua` - 添加Linux链接器标志

## 验证步骤

验证模块系统是否正常工作：

1. **构建项目**:
   ```bash
   xmake
   ```

2. **运行任何应用程序**:
   ```bash
   xmake run DefaultGame
   # 或
   xmake run TestRHIApp
   # 或
   xmake run CustomModule
   ```

3. **检查控制台输出**:
   - 模块注册消息
   - 模块启动消息
   - 没有"not found in registry"错误
   - 所有预期模块都列在"Loaded Engine Modules"中

4. **验证模块关闭**:
   - 退出应用程序
   - 检查ShutdownModule()消息
   - 应该按相反顺序关闭

## 参考

这个实现遵循Unreal Engine的模块系统设计：
- 通过宏注册模块
- 在main()之前自动注册
- 显式加载并解决依赖关系
- 生命周期钩子（Startup/Shutdown）
- 基于类型的分类
- 有序关闭

更多信息请参见：
- `src/Runtime/Core/Public/Modules/Module.h` - 模块管理器和宏
- `src/Runtime/Core/Public/Modules/ModuleInterface.h` - 模块接口
- `src/Runtime/Core/Public/Modules/ModuleDescriptor.h` - 模块元数据
- `src/Runtime/Core/Private/Modules/ModuleExamples.cpp` - 示例模块
- `docs/MODULE_SYSTEM_REFACTORING_2026_02_02.md` - 详细英文文档
